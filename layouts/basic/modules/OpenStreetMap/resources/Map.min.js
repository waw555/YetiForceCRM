
jQuery.Class("OpenStreetMap_Map_Js",{},{container:false,mapInstance:false,selectedParams:false,layerMarkers:false,markers:false,polygonLayer:false,routeLayer:false,recordsIds:false,cacheLayerMarkers:{},indirectPointLayer:{},setSelectedParams:function(a){this.selectedParams=a},registerMap:function(c,a){var b=L.map("mapid").setView(c,a);L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(b);this.mapInstance=b;return b},setMarkersByResponse:function(h){var q=this;var m=[];var e=this.container;var d=this.mapInstance;if(typeof h.result.coordinates!="undefined"){var p=h.result.coordinates;var i=L.markerClusterGroup({maxClusterRadius:10});d.removeLayer(this.layerMarkers);var f=[];p.forEach(function(s){m.push([s.lat,s.lon]);var r=L.marker([s.lat,s.lon],{icon:L.AwesomeMarkers.icon({icon:"home",markerColor:"blue",prefix:"fa",iconColor:s.color})}).bindPopup(s.label);i.addLayer(r);f.push(s.recordId)});this.recordsIds=f;this.markers=p;this.layerMarkers=i;d.addLayer(i)}d.removeLayer(this.polygonLayer);if(typeof h.result.coordinatesCeneter!="undefined"){if(typeof h.result.coordinatesCeneter.error=="undefined"){var l=e.find(".radius").val();m.push([h.result.coordinatesCeneter.lat,h.result.coordinatesCeneter.lon]);var c='<span class="description">'+e.find(".searchValue").val()+'</span><br><input type=hidden class="coordinates" data-lon="'+h.result.coordinatesCeneter.lon+'" data-lat="'+h.result.coordinatesCeneter.lat+'">';c+='<button class="btn btn-success btn-xs startTrack marginRight10"><span class="fa fa-truck"></span></button>';c+='<button class="btn btn-danger btn-xs endTrack"><span class="fa fa-flag-checkered"></span></button>';var j=L.marker([h.result.coordinatesCeneter.lat,h.result.coordinatesCeneter.lon],{icon:L.AwesomeMarkers.icon({icon:"search",markerColor:"red",prefix:"fa",})}).bindPopup(c);i.addLayer(j);if($.isNumeric(l)){l=parseInt(l)*1000;var b=L.circle([h.result.coordinatesCeneter.lat,h.result.coordinatesCeneter.lon],l,{color:"red",fillColor:"#f03",fillOpacity:0.05});this.polygonLayer=L.featureGroup([b]);d.addLayer(this.polygonLayer)}}else{var g={title:app.vtranslate("JS_LBL_PERMISSION"),text:h.result.coordinatesCeneter.error,type:"error",animation:"show"};Vtiger_Helper_Js.showMessage(g)}}if(typeof h.result.cache!="undefined"){var a=h.result.cache;Object.keys(a).forEach(function(s){if(typeof q.cacheLayerMarkers[s]!="undefined"){d.removeLayer(q.cacheLayerMarkers[s])}var r=L.markerClusterGroup({maxClusterRadius:10});p=a[s];p.forEach(function(u){if(q.recordsIds.indexOf(u.recordId)===-1){m.push([u.lat,u.lon]);var t=L.marker([u.lat,u.lon],{icon:L.AwesomeMarkers.icon({icon:"home",markerColor:"orange",prefix:"fa",iconColor:u.color})}).bindPopup(u.label);r.addLayer(t)}});d.addLayer(r);q.cacheLayerMarkers[s]=r})}var o=this.container.find(".modal-footer");if(typeof h.result.legend!="undefined"){var k="";var n=h.result.legend;n.forEach(function(r){k+='<div class="pull-left"><span class="leegendIcon" style="background:'+r.color+'"></span> '+r.value+"</div>"});o.html(k)}else{o.html("")}if(m.length){d.fitBounds(m)}this.container.find(".groupNeighbours").prop("checked",true)},showCalculateBtn:function(){var b=this.container;var a=b.find(".end").val();var c=b.find(".start").val();if(a.length>0&&c.length>0){b.find(".calculateTrack").removeClass("hide")}},registerCacheEvents:function(a){var b=this;a.find(".showRecordsFromCache").on("change",function(f){var d=$(f.currentTarget);var c=d.data("module");if(d.is(":checked")){var g={module:"OpenStreetMap",action:"GetMarkers",srcModule:app.getModuleName(),cache:[c],};AppConnector.request(g).then(function(e){b.setMarkersByResponse(e)})}else{b.mapInstance.removeLayer(b.cacheLayerMarkers[c])}});a.find(".copyToClipboard").on("click",function(){var c={module:"OpenStreetMap",action:"ClipBoard",mode:"save",recordIds:JSON.stringify(b.recordsIds),srcModule:app.getModuleName()};AppConnector.request(c).then(function(d){Vtiger_Helper_Js.showMessage({title:app.vtranslate("JS_LBL_PERMISSION"),text:app.vtranslate("JS_NOTIFY_COPY_TEXT"),type:"success",animation:"show"});var e=a.find(".countRecords"+app.getModuleName());e.html(d.result);e.closest(".cacheModuleContainer").find(".deleteClipBoard").removeClass("hide")})});a.find(".deleteClipBoard").on("click",function(f){var d=$(f.currentTarget);var c=d.data("module");var g={module:"OpenStreetMap",action:"ClipBoard",mode:"delete",srcModule:c};AppConnector.request(g).then(function(e){var i={title:app.vtranslate("JS_LBL_PERMISSION"),text:app.vtranslate("JS_SAVE_NOTIFY_OK"),type:"success",animation:"show"};Vtiger_Helper_Js.showMessage(i);var h=a.find(".countRecords"+c);h.html("");d.addClass("hide");h.closest(".cacheModuleContainer").find(".showRecordsFromCache").prop("checked",false);h.closest(".cacheModuleContainer").find(".showRecordsFromCache").trigger("change")})});a.find(".addAllRecords").on("click",function(f){var d=$(f.currentTarget);var c=d.data("module");var g={module:"OpenStreetMap",action:"ClipBoard",mode:"addAllRecords",srcModule:c};AppConnector.request(g).then(function(e){var i={title:app.vtranslate("JS_LBL_PERMISSION"),text:app.vtranslate("JS_SAVE_NOTIFY_OK"),type:"success",animation:"show"};Vtiger_Helper_Js.showMessage(i);a.find(".countRecords"+c).html(e.result.count);var h=d.closest(".cacheModuleContainer");h.find(".showRecordsFromCache").prop("checked",true);h.find(".showRecordsFromCache").trigger("change");if(e.result.count!="0"){h.find(".deleteClipBoard").removeClass("hide")}})})},getCacheParamsToRequest:function(){var a=this.container;var b=[];a.find(".showRecordsFromCache").each(function(){var c=$(this);if(c.is(":checked")){b.push(c.data("module"))}});return b},registerSearchCompany:function(){var a=this.container;var d=a.find(".searchCompany");var b=a.find(".searchModule");var c=a.find(".addRecord");var e=this.mapInstance;var f=this.layerMarkers;c.on("click",function(){var g=c.data("crmId");if(g==""){return false}AppConnector.request({module:"OpenStreetMap",action:"ClipBoard",mode:"addRecord",record:g,srcModuleName:b.val()}).then(function(i){c.data("crmId","");if(i.result.length==1){var h=L.marker([i.result[0].lat,i.result[0].lon],{icon:L.AwesomeMarkers.icon({icon:"home",markerColor:"cadetblue",prefix:"fa",iconColor:i.result[0].color})}).bindPopup(i.result[0].label);f.addLayer(h);e.addLayer(f);e.setView(new L.LatLng(i.result[0].lat,i.result[0].lon),14)}else{Vtiger_Helper_Js.showMessage({title:app.vtranslate("JS_LBL_PERMISSION"),text:i.result,type:"error",animation:"show"})}d.val("")})});$.widget("custom.ivAutocomplete",$.ui.autocomplete,{_create:function(){this._super();this.widget().menu("option","items","> :not(.ui-autocomplete-category)")},_renderMenu:function(i,h){var j=this,g="";$.each(h,function(l,m){var k;if(m.category!=g){i.append("<li class='ui-autocomplete-category'>"+m.category+"</li>");g=m.category}j._renderItemData(i,m)})},_renderItemData:function(g,h){return this._renderItem(g,h).data("ui-autocomplete-item",h)},_renderItem:function(g,h){return $("<li>").data("item.autocomplete",h).append($("<a></a>").html(h.label)).appendTo(g)},});d.ivAutocomplete({delay:"600",minLength:"3",source:function(h,g){AppConnector.request({module:app.getModuleName(),view:"BasicAjax",mode:"showSearchResults",value:d.val(),searchModule:b.val(),html:false,}).then(function(j){j=JSON.parse(j);var i=j.result;if(i.length<=0){i.push({label:app.vtranslate("JS_NO_RESULTS_FOUND"),type:"no results",category:""})}g(i)})},select:function(h,i){var g=i.item;c.data("crmId",g.id)},close:function(g,h){}})},registerBasicModal:function(){var d=this;var a=this.container;var e=d.mapInstance;d.registerCacheEvents(a);a.find(".groupBy").on("click",function(){var f=jQuery.progressIndicator({position:a,blockInfo:{enabled:true}});var g={module:"OpenStreetMap",action:"GetMarkers",srcModule:app.getModuleName(),groupBy:a.find(".fieldsToGroup").val(),searchValue:a.find(".searchValue").val(),radius:a.find(".radius").val(),cache:d.getCacheParamsToRequest(),};$.extend(g,d.selectedParams);AppConnector.request(g).then(function(h){f.progressIndicator({mode:"hide"});d.setMarkersByResponse(h)})});a.find(".groupNeighbours").on("change",function(i){var h=$(i.currentTarget);e.removeLayer(d.layerMarkers);var j=d.markers;if(h.is(":checked")){var f=L.markerClusterGroup({maxClusterRadius:10});j.forEach(function(l){var k=L.marker([l.lat,l.lon],{icon:L.AwesomeMarkers.icon({icon:"home",markerColor:"blue",prefix:"fa",iconColor:l.color})}).bindPopup(l.label);f.addLayer(k)})}else{var g=[];j.forEach(function(l){var k=L.marker([l.lat,l.lon],{icon:L.AwesomeMarkers.icon({icon:"home",markerColor:"blue",prefix:"fa",iconColor:l.color})}).bindPopup(l.label);g.push(k)});var f=L.featureGroup(g)}d.layerMarkers=f;e.addLayer(f)});a.find(".searchBtn").on("click",function(g){var f=jQuery.progressIndicator({position:a,blockInfo:{enabled:true}});var h={module:"OpenStreetMap",action:"GetMarkers",srcModule:app.getModuleName(),searchValue:a.find(".searchValue").val(),radius:a.find(".radius").val(),cache:d.getCacheParamsToRequest(),};$.extend(h,d.selectedParams);AppConnector.request(h).then(function(i){f.progressIndicator({mode:"hide"});d.setMarkersByResponse(i)})});var b=false;a.on("click",".startTrack",function(k){e.removeLayer(b);var j=$(k.currentTarget);var g=j.closest(".leaflet-popup-content");var i=g.find(".description").html();var h=a.find(".start");var l=g.find(".coordinates");var i=i.replace(/\<br\>/gi,", ");h.val(i);h.data("lat",l.data("lat"));h.data("lon",l.data("lon"));var f=L.marker([l.data("lat"),l.data("lon")],{icon:L.AwesomeMarkers.icon({icon:"truck",markerColor:"green",prefix:"fa",})}).bindPopup(g.html());b=L.featureGroup([f]);e.addLayer(b);d.showCalculateBtn()});var c=false;a.on("click",".endTrack",function(k){e.removeLayer(c);var j=$(k.currentTarget);var g=j.closest(".leaflet-popup-content");var i=g.find(".description").html();var h=a.find(".end");var l=g.find(".coordinates");var i=i.replace(/\<br\>/gi,", ");h.val(i);h.data("lat",l.data("lat"));h.data("lon",l.data("lon"));var f=L.marker([l.data("lat"),l.data("lon")],{icon:L.AwesomeMarkers.icon({icon:"flag-checkered",markerColor:"red",prefix:"fa",})}).bindPopup(g.html());c=L.featureGroup([f]);e.addLayer(c);d.showCalculateBtn()});a.on("click",".indirectPoint",function(i){var f=$(i.currentTarget);var j=f.closest(".leaflet-popup-content");var l=j.find(".description").html();var m=a.find(".indirectTemplate");var g=m.clone();m.after(g);g.removeClass("indirectTemplate");g.removeClass("hide");var k=j.find(".coordinates");var l=l.replace(/\<br\>/gi,", ");if(typeof d.indirectPointLayer[l]!="undefined"){e.removeLayer(d.indirectPointLayer[l])}var n=g.find(".indirect");n.val(l);n.data("lat",k.data("lat"));n.data("lon",k.data("lon"));var h=L.marker([k.data("lat"),k.data("lon")],{icon:L.AwesomeMarkers.icon({icon:"flag",markerColor:"orange",prefix:"fa",})}).bindPopup(j.html());d.indirectPointLayer[l]=L.featureGroup([h]);e.addLayer(d.indirectPointLayer[l])});a.on("click",".removeIndirect",function(h){var g=$(h.currentTarget);var f=g.closest(".indirectContainer");e.removeLayer(d.indirectPointLayer[f.find(".indirect").val()]);g.closest(".indirectContainer").remove()});a.on("click",".searchInRadius",function(i){e.removeLayer(c);var h=$(i.currentTarget);var f=h.closest(".leaflet-popup-content");var k=f.find(".coordinates");var g=jQuery.progressIndicator({position:a,blockInfo:{enabled:true}});var j={module:"OpenStreetMap",action:"GetMarkers",srcModule:app.getModuleName(),radius:a.find(".radius").val(),lat:k.data("lat"),lon:k.data("lon"),cache:d.getCacheParamsToRequest(),};$.extend(j,d.selectedParams);AppConnector.request(j).then(function(l){g.progressIndicator({mode:"hide"});d.setMarkersByResponse(l)})});a.find(".calculateTrack").on("click",function(){var g=[];var f=[];a.find(".indirectContainer:not(.hide) input.indirect").each(function(){var l=$(this);f.push(l.data("lat"));g.push(l.data("lon"))});var h=a.find(".end");var i=a.find(".start");var j=jQuery.progressIndicator({position:a,blockInfo:{enabled:true}});var k={url:"index.php",data:{module:"OpenStreetMap",action:"GetRoute",flon:i.data("lon"),flat:i.data("lat"),ilon:g,ilat:f,tlon:h.data("lon"),tlat:h.data("lat")}};AppConnector.request(k).then(function(m){j.progressIndicator({mode:"hide"});e.removeLayer(d.routeLayer);var l=L.geoJson(m.result);d.routeLayer=L.featureGroup([l]);e.addLayer(d.routeLayer);a.find(".descriptionContainer").removeClass("hide");a.find(".descriptionContent .instruction").html(m.result.properties.description);a.find(".descriptionContent .distance").html(app.parseNumberToShow(m.result.properties.distance));a.find(".descriptionContent .travelTime").html(app.parseNumberToShow(m.result.properties.traveltime/60))})});a.find(".setView").on("click",function(h){var g=$(h.currentTarget);var j=g.closest(".input-group").find(".end,.start");var f=j.data("lat");var i=j.data("lon");if(!(typeof f=="undefined"&&typeof i=="undefined")){e.setView(new L.LatLng(f,i),14)}});this.registerSearchCompany()},registerModalView:function(a){var d=this;var e=jQuery.progressIndicator({position:a,blockInfo:{enabled:true}});var c=$("body").height();this.container=a;var g=[0,0];var b=2;$("#mapid").css({height:c-200});this.registerMap(g,b);var f={module:"OpenStreetMap",action:"GetMarkers",srcModule:app.getModuleName(),};$.extend(f,this.selectedParams);AppConnector.request(f).then(function(h){e.progressIndicator({mode:"hide"});d.setMarkersByResponse(h);d.registerBasicModal()})},registerDetailView:function(a){this.container=a;var f=a.find("#coordinates").val();f=JSON.parse(f);var h=[0,0];var b=2;if(f.length){h=f[0];b=6}var g=$("#mapid").position();var c=$(".footerContainer ").position();$("#mapid").css({height:c.top-g.top-281});var e=this.registerMap(h,b);var d=L.markerClusterGroup({maxClusterRadius:10});f.forEach(function(j){var i=L.marker([j.lat,j.lon],{icon:L.AwesomeMarkers.icon({icon:"home",markerColor:"blue",prefix:"fa",iconColor:j.color})}).bindPopup(j.label);d.addLayer(i)});e.addLayer(d)}});