
Vtiger_Edit_Js("Calendar_Edit_Js",{},{isEvents:function(){var b=this.getForm();var a=b.find('[name="module"]').val();if(a=="Events"){return true}return false},registerReminderFieldCheckBox:function(){this.getForm().find('input[name="set_reminder"]').on("change",function(c){var b=jQuery(c.currentTarget);var a=b.closest("div").next();if(b.is(":checked")){a.removeClass("hide")}else{a.addClass("hide")}})},registerRecurrenceFieldCheckBox:function(){var a=this;a.getForm().find('input[name="recurringcheck"]').on("change",function(d){var c=jQuery(d.currentTarget);var b=jQuery("#repeatUI");if(c.is(":checked")){b.removeClass("hide")}else{b.addClass("hide")}})},registerRecurringTypeChangeEvent:function(){var a=this;jQuery("#recurringType").on("change",function(d){var c=jQuery(d.currentTarget);var b=c.val();a.changeRecurringTypesUIStyles(b)})},registerRepeatMonthActions:function(){var a=this;a.getForm().find('input[name="repeatMonth"]').on("change",function(b){a.repeatMonthOptionsChangeHandling()})},changeRecurringTypesUIStyles:function(b){var a=this;if(b=="Daily"||b=="Yearly"){jQuery("#repeatWeekUI").removeClass("show").addClass("hide");jQuery("#repeatMonthUI").removeClass("show").addClass("hide")}else{if(b=="Weekly"){jQuery("#repeatWeekUI").removeClass("hide").addClass("show");jQuery("#repeatMonthUI").removeClass("show").addClass("hide")}else{if(b=="Monthly"){jQuery("#repeatWeekUI").removeClass("show").addClass("hide");jQuery("#repeatMonthUI").removeClass("hide").addClass("show")}}}},repeatMonthOptionsChangeHandling:function(){if(jQuery("#repeatDay").is(":checked")){jQuery("#repeatMonthDate").attr("disabled",true);jQuery("#repeatMonthDayType").prop("disabled",false);jQuery("#repeatMonthDay").prop("disabled",false)}else{jQuery("#repeatMonthDate").removeAttr("disabled");jQuery("#repeatMonthDayType").prop("disabled",true);jQuery("#repeatMonthDay").prop("disabled",true)}},setDefaultEndTime:function(h){var j=h.find('[name="date_start"]');var m=h.find('[name="time_start"]');var c=h.find('[name="time_end"]');var r=h.find('[name="due_date"]');if(jQuery('[name="userChangedEndDateTime"]').val()=="1"){return}var b=j.val();var k=m.val();var g=Vtiger_Time_Validator_Js.invokeValidation(m);if(g!=true){return}var p=b+" "+k;var n=h.find('[name="due_date"]').data("dateFormat");var a=c.data("format");var b=Vtiger_Helper_Js.getDateInstance(p,n);var i=Date.parse(b);var f=false;if(h.find('[name="activitytype"]').val()=="Call"){var d=h.find('[name="defaultCallDuration"]').val();f=i.addMinutes(d)}else{var o=h.find('[name="defaultOtherEventDuration"]').val();f=i.addMinutes(o)}var e=app.getDateInVtigerFormat(n,f);if(a==24){var l="HH:mm"}else{l="hh:mm tt"}var q=i.toString(l);r.val(e);c.val(q)},registerActivityTypeChangeEvent:function(a){var b=this;a.on("change",'select[name="activitytype"]',function(c){b.setDefaultEndTime(a)})},registerTimeStartChangeEvent:function(a){var b=this;a.find('input[name="time_start"]').on("change",function(c){b.setDefaultEndTime(a)});a.find('[name="date_start"]').on("change",function(l){var k=jQuery(l.currentTarget);var d=a.find('[name="due_date"]');var g=b.getDateInstance(a,"start");var i=b.getDateInstance(a,"end");var f=$("#userDateFormat").val();var h=$("#userTimeFormat").val();a.find(".autofill:visible").trigger("change");if(g>i){i=g;var j=app.getDateInVtigerFormat(f,i);d.val(j);app.registerEventForDatePickerFields(a)}var c=k.closest(".fieldValue").find('[name="time_start"]');c.trigger("changeTime")});a.find('input[name="time_start"]').on("focus",function(d){var c=jQuery(d.currentTarget);c.data("prevValue",c.val())});a.find('input[name="time_start"]').on("blur",function(i,g){if(typeof g=="undefined"){g={}}if(typeof g.forceChange=="undefined"){g.forceChange=false}var c=jQuery(i.currentTarget);var d=c.val();var h=c.data("prevValue");if(d!=h||g.forceChange){var f=c.data("timepicker-list");if(!f){c.timepicker("show");c.timepicker("hide");f=c.data("timepicker-list")}i=jQuery.Event("keydown");i.which=13;i.keyCode=13;c.trigger(i)}})},setVisibilityBtnSaveAndClose:function(a){var d=a.find('input[name="due_date"]');var f=d.data("date-format");var g=d.val();var c=a.find('input[name="time_end"]');var e=c.val();var i=g+" "+e;var h=Vtiger_Helper_Js.getDateInstance(i,f);var b=h-new Date();if(b>=0){a.find(".saveAndComplete").addClass("hide")}else{a.find(".saveAndComplete").removeClass("hide")}},registerEndDateTimeChangeLogger:function(a){var b=this;a.find('[name="time_end"]').on("change",function(g){var f=jQuery(g.currentTarget);var c=Vtiger_Time_Validator_Js.invokeValidation(f);if(c!=true){return}var d=f.closest(".fieldValue").find('[name="due_date"]');jQuery('[name="userChangedEndDateTime"]').val("1");d.data("userChangedTime",true)});a.find('[name="due_date"]').on("change",function(f){var d=jQuery(f.currentTarget);var c=Vtiger_Date_Validator_Js.invokeValidation(d);if(c!=true){return}b.setVisibilityBtnSaveAndClose(a);jQuery('[name="userChangedEndDateTime"]').val("1");d.data("userChangedTime",true)})},registerFormSubmitEvent:function(){var b=this;var a=this.getForm();a.on("submit",function(d){var g=a.find('input[name="recurringcheck"]').is(":checked");if(g==false){jQuery("#recurringType").append(jQuery('<option value="--None--">None</option>')).val("--None--")}if(b.isEvents()){var c=a.find(".inviteesContent .inviteRow");var f=[];c.each(function(e,i){var h=jQuery(i);if(h.data("crmid")!=""){f.push([h.data("email"),h.data("crmid"),h.data("ivid")])}});jQuery('<input type="hidden" name="inviteesid" />').appendTo(a).val(JSON.stringify(f))}})},getFreeTime:function(b){var d=b.find('[name="time_start"], [data-element-name="time_start"]');var a=b.find('[name="time_end"], [data-element-name="time_end"]');var c=b.find('[name="date_start"], [data-element-name="date_start"]');var e={module:"Calendar",action:"GetFreeTime",dateStart:c.val()};b.progressIndicator({});AppConnector.request(e).then(function(f){b.progressIndicator({mode:"hide"});d.val(f.result.time_start);a.val(f.result.time_end);c.val(f.result.date_start);b.find('[name="due_date"]').val(f.result.date_start)})},registerAutoFillHours:function(b){var d=this;var e=b.find('[name="allday"]');var f=b.find('[name="time_start"]');var a=b.find('[name="time_end"]');var c=b.find('[name="due_date"]');b.find(".autofill").on("change",function(h){var g=$(h.currentTarget);if(g.is(":checked")){b.find(".autofill").attr("checked","checked");d.getFreeTime(b);f.attr("readonly","readonly");a.attr("readonly","readonly");e.attr("disabled","disabled");e.removeAttr("checked");e.trigger("change");c.attr("readonly","readonly")}else{b.find(".autofill").removeAttr("checked");e.removeAttr("disabled");f.removeAttr("readonly");a.removeAttr("readonly");c.removeAttr("readonly")}})},registerSaveAndCloseBtn:function(a){this.setVisibilityBtnSaveAndClose(a);a.find(".saveAndComplete").on("click",function(){var b=a.data("jqv").InvalidFields;if(b.length==0){a.append('<input type=hidden name="saveAndClose" value="PLL_COMPLETED">')}a.find('[type="submit"]').trigger("click")})},registerBasicEvents:function(a){this._super(a);this.toggleTimesInputs(a);this.registerTimesInputs(a);this.registerTimeStartChangeEvent(a);this.registerActivityTypeChangeEvent(a);this.registerEndDateTimeChangeLogger(a);this.registerAutoFillHours(a);this.registerSaveAndCloseBtn(a)},toggleTimesInputs:function(a){a.find(":checkbox").change(function(){var b=$(this).attr("name");if("allday"==b){var c=$(this).is(":checked");if(!a.find("#quickCreate").length){if(c){a.find(".time").hide()}else{a.find(".time").show()}}}})},registerTimesInputs:function(b){var a=b.find('[name="allday"]:checkbox');if(a.prop("checked")){b.find(".time").hide()}},getDateInstance:function(d,m){var l=d.find('[name="date_start"]');var c=d.find('[name="due_date"]');var g=d.find('[name="time_end"]');var i=d.find('[name="time_start"]');var f=l.val();var e=i.val();var k=g.val();var j=c.val();var b=$("#userDateFormat").val();var h=$("#userTimeFormat").val();if(m=="start"){var a=Vtiger_Helper_Js.getDateInstance(f+" "+e,b)}if(m=="end"){var a=Vtiger_Helper_Js.getDateInstance(j+" "+k,b)}return a},registerInviteEvent:function(d){var c=this;this.registerRow(d);var a=d.find(".inviteesContent");var b=d.find("input.inviteesSearch");$.widget("custom.ivAutocomplete",$.ui.autocomplete,{_create:function(){this._super();this.widget().menu("option","items","> :not(.ui-autocomplete-category)")},_renderMenu:function(g,f){var h=this,e="";$.each(f,function(j,k){var i;if(k.category!=e){g.append("<li class='ui-autocomplete-category'>"+k.category+"</li>");e=k.category}h._renderItemData(g,k)})},_renderItemData:function(e,f){return this._renderItem(e,f).data("ui-autocomplete-item",f)},_renderItem:function(e,f){return $("<li>").data("item.autocomplete",f).append($("<a></a>").html(f.label)).appendTo(e)},});b.ivAutocomplete({delay:"600",minLength:"3",source:function(f,e){AppConnector.request({module:"Calendar",action:"Invitees",mode:"find",value:f.term}).then(function(g){var h=g.result;if(h.length<=0){h.push({label:app.vtranslate("JS_NO_RESULTS_FOUND"),type:"no results",category:""})}e(h)})},select:function(g,h){var f=h.item;if(typeof f.type!="undefined"&&f.type=="no results"){return false}var e=true;a.find(".inviteRow").each(function(j){if($(this).data("crmid")==f.id){e=false}});if(e){var i=a.find(".hide .inviteRow").clone(true,true);Vtiger_Index_Js.getEmailFromRecord(f.id,f.module).then(function(j){i.data("crmid",f.id);i.data("email",j);i.find(".inviteName").data("content",f.fullLabel+j).text(f.label);i.find(".inviteIcon .glyphicon").removeClass("glyphicon glyphicon-envelope").addClass("userIcon-"+f.module);a.append(i)})}},close:function(e,f){b.val("")}})},registerRow:function(b){var a=this;b.on("click",".inviteRemove",function(c){$(c.target).closest(".inviteRow").remove()})},registerEvents:function(){var a=this.proceedRegisterEvents();if(!a){return}var b=this.getForm();this.registerReminderFieldCheckBox();this.registerRecurrenceFieldCheckBox();this.registerFormSubmitEvent();this.repeatMonthOptionsChangeHandling();this.registerRecurringTypeChangeEvent();this.registerRepeatMonthActions();if(this.isEvents()){this.registerInviteEvent(b)}this._super()}});